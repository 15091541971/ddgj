<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"      
 "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="com.doudinggongjiang.think.dao.IdeaDao">


	<!-- 创意的结果集（不包括评论） -->

	<resultMap id="IdeaResult" type="com.doudinggongjiang.think.vo.Idea">
		<result column="ispraise" property="ispraise" javaType="boolean"
			typeHandler="org.apache.ibatis.type.BooleanTypeHandler" />
		<result column="iswantto" property="iswantto" javaType="boolean"
			typeHandler="org.apache.ibatis.type.BooleanTypeHandler" />
		<result column="isfavorites" property="isfavorites" javaType="boolean"
			typeHandler="org.apache.ibatis.type.BooleanTypeHandler" />
		<result property="createdate" column="createdate" javaType="java.util.Date" />
		<association property="type" column="type" javaType="String"
			select="selectTypeByID" />
		<association property="fromId" column="fromId"
			javaType="com.gj.entity.UserInfo" select="selectUserInfo" />
	</resultMap>
	<!-- 创意的结果集（包括评论） -->
	<resultMap id="IdeaResultHaveComment" type="com.doudinggongjiang.think.vo.Idea">

		<association property="type" column="type" javaType="String"
			select="selectTypeByID" />
		<association property="fromId" column="fromId"
			javaType="com.gj.entity.UserInfo" select="selectUserInfo" />

		<collection property="comment" column="idea_id"
			ofType="com.gj.entity.Comment" select="selectCommentByIdeaId">
			<id column="comment_id" javaType="int" jdbcType="INTEGER"
				property="comment_id" />
			<!-- <result property="idea_id" column="idea_id" javaType="string" /> -->
			<result column="context" property="context" javaType="string" />
			<association property="user" column="user_id"
				javaType="com.gj.entity.UserInfo" select="selectUserUser" />
		   </collection>
	</resultMap>
	<!-- 评论的结果集 -->
	<resultMap type="com.gj.entity.Comment" id="commentResult">
		<result property="context" column="context" javaType="string" />
		<association property="user" column="user_id"
			javaType="com.gj.entity.UserInfo" select="selectUserInfo" />

	</resultMap>

	<sql id="idea">
		SELECT a4.idea_Id,a5.wantTo,a5.favorites FROM tb_idea AS a4 LEFT JOIN (

		SELECT COUNT(*) AS wanTto,a2.idea_id,a3.favorites FROM
		tb_idea_wantto AS a2
		JOIN (SELECT COUNT(*) AS favorites,a1.idea_id FROM
		tb_idea_favorites AS a1 GROUP BY a1.idea_id) AS a3 ON a2.idea_id=a3.idea_id
		GROUP BY a2.idea_id) AS a5 ON a4.idea_id=a5.idea_id
	</sql>
	<sql id="ideafile">
		idea.idea_Id,idea.title,idea.detail,idea.picture,
		idea.type,idea.fromId,idea.createdate,idea.status,
		idea.views,favorites.favorites, praise.praise
	</sql>
	<sql id="ideafile_myfavorite">
		idea.idea_Id,idea.title,idea.detail,idea.picture,
		idea.type,idea.fromId,idea.createdate,idea.status,
		idea.views,favorites.favorites, praise.praise,favorites.user_id
	</sql>
	<!-- 查找某个创意收藏的数量 -->
	<sql id="favoriteCountAll">
		(SELECT COUNT(*) AS favorites ,idea_id
		FROM
		tb_idea_favorites
		GROUP BY idea_id) AS favorites
	</sql>
	<!-- 查找某个创意收藏的数量和用户 -->
	<sql id="favoriteCountAllAndUser">
		(SELECT COUNT(*) AS favorites ,idea_id,user_id
		FROM
		tb_idea_favorites GROUP BY idea_id) AS favorites
	</sql>
	<sql id="praiseCountAll">
		(SELECT COUNT(*) AS praise,idea_id FROM tb_idea_praise
		GROUP BY idea_id) AS
		praise
	</sql>
	<!-- 是否想要购买 -->
	<sql id="iswantto">
		(SELECT EXISTS (SELECT * FROM tb_idea_wantto WHERE idea_id=#{idea.idea_Id}
		AND user_id=#{user_id} ) AS iswantto,idea_id FROM tb_idea_wantto where
		idea_id=#{idea.idea_Id}) AS iswantto
	</sql>
	<!-- 是否点赞 -->
	<sql id="ispraise">
		(SELECT EXISTS (SELECT * FROM tb_idea_praise WHERE idea_id=#{idea.idea_Id}
		AND user_id=#{user_id} ) AS ispraise,idea_id FROM tb_idea_praise where
		idea_id=#{idea.idea_Id}) AS ispraise
	</sql>
	<!-- 是否被收藏 -->
	<sql id="isfavorites">
		(SELECT EXISTS (SELECT * FROM tb_idea_favorites WHERE idea_id=#{idea.idea_Id}
		AND user_id=#{user_id} ) AS isfavorites,idea_id FROM tb_idea_favorites
		where idea_id=#{idea.idea_Id}) AS isfavorites
	</sql>
	<sql id="IdeaOfModule"></sql>
	<!-- <insert id="addIdea" parameterType="com.doudinggongjiang.think.vo.Idea">
	insert into  tb_idea(idea_Id,title,detail,picture,type,fromId,createdate) values(#{idea_Id},#{title},#{detail},#{picture},#{type},#{fromId.userId},#{createdate})
	</insert> -->
	<!--查找创意 -->
	<select id="selectIdea" resultMap="IdeaResult"
		parameterType="com.doudinggongjiang.think.vo.IdeaParamer">
		
		 SELECT a4.*,a3.favorites,a7.COMMENT, a8.wanTto,a6.praise ,iswantto.iswantto,ispraise.ispraise,isfavorites.isfavorites
		 FROM tb_idea AS a4  
         LEFT JOIN (SELECT COUNT(*) AS praise ,idea_id FROM tb_idea_praise GROUP BY
		 idea_id )AS a6 ON a4.`idea_id`=a6.idea_id 
		 LEFT JOIN (SELECT COUNT(*) AS favorites,a1.idea_id FROM
		 tb_idea_favorites AS a1 GROUP BY a1.idea_id) AS a3 ON a4.idea_id=a3.idea_id
		 LEFT JOIN (SELECT COUNT(*) AS COMMENT ,idea_id FROM tb_idea_comment GROUP
		 BY idea_id )AS a7 ON a4.`idea_id`=a7.idea_id
		 LEFT JOIN (SELECT COUNT(*) AS wanTto,a2.idea_id FROM tb_idea_wantto AS a2 GROUP BY a2.idea_id) AS a8 ON a4.idea_id=a8.idea_id

		 LEFT JOIN
		<include refid="iswantto" />
		ON a4.idea_id=iswantto.idea_id
		LEFT JOIN
		<include refid="ispraise" />
		ON a4.idea_id=ispraise.idea_id
		LEFT JOIN
		<include refid="isfavorites" />
		ON a4.idea_id=isfavorites.idea_id
		

		<where>
		<choose>
			<when test="idea!=null and idea.idea_Id !=null and ''!=idea.idea_Id ">
				a4.idea_id=#{idea.idea_Id} and a4.status!=3
			</when>
			
			 <when test="idea==null and fromId==null">
			<if test="list!=null">
				<foreach collection="list" index="index" item="item" open="("
					separator="or" close=")">
					a4.title like #{item}
				</foreach>
				
			</if>
			<!-- <if test="type!=0 ">
				and a4.type = #{type} 
			</if> -->
				and a4.status=#{status}  limit #{size},#{pageMaxSize}
			</when> 
			<when test="fromId!=null and ''!=fromId">
				a4.fromId=#{fromId}  and a4.status!=3 limit  #{size},#{pageMaxSize}
			</when>

			<!--  <otherwise>
				1=1 and a4.status=#{status} limit #{size},#{pageMaxSize}
			</otherwise>

 -->


        </choose>
		</where>
		


	</select>

	<!-- 查找用户信息 -->
	<select id="selectUserInfo" resultType="com.gj.entity.UserInfo">

		SELECT * FROM
		view_user_info where userId=#{fromId}
	</select>
	<!-- 删除创意 -->
	<update id="updateIdeaStatus" parameterType="com.doudinggongjiang.think.vo.IdeaParamer">


		update tb_idea set status=#{status} where idea_id=#{idea.idea_Id}
	</update>
	<!-- 品论发布者信息 -->
	<select id="selectUserUser" resultType="com.gj.entity.UserInfo">

		SELECT * FROM
		view_user_info where userId=#{user_id}
	</select>

	<!-- 查看某个创意是否被收藏 -->
	<select id="isPraiseIdea" resultType="int" parameterType="string">
		select
		count(*) from tb_idea_praise where idea_id=#{idea_id} and
		user_id=#{user_id}
	</select>

	<!-- 查看某个创意是否被收藏 -->
	<select id="isFavoriteIdea" resultType="int" parameterType="string">
		select count(*) from tb_idea_favorites where idea_id=#{idea_id} and
		user_id=#{user_id}
	</select>
	<!-- 收藏创意 -->
	<insert id="addFavoriteIdea" parameterType="String">

		INSERT INTO
		tb_idea_favorites(idea_id,user_id)
		
		values(#{idea_id},#{user_id})
	</insert>
	<delete id="removeFavoriteIdea" parameterType="string">
		delete from
		tb_idea_favorites where idea_id=#{idea_id} and
		user_id=#{user_id}
	</delete>
	<!--根据id查找某一个创意收藏的数量 -->
	<select id="favoriteCountbyIdea_id" resultType="int"
		parameterType="string">
		select count(*) from tb_idea_favorites where
		idea_id=#{idea_id}
	</select>
	<sql id="wanToCountOfIdea">
		(select count(*) as wantTo, idea_id from
		tb_idea_wantto GROUP BY idea_id) AS wantto
	</sql>

	<!-- 查找某个用户收藏的创意 -->
	<select id="selectMyFavorite" resultMap="IdeaResult">
		select
		<include refid="ideafile_myfavorite" />
		,wantto.wantTo,wantto.idea_id
		FROM tb_idea AS idea LEFT JOIN
		<include refid="favoriteCountAllAndUser" />
		ON idea.idea_id=favorites.idea_id LEFT JOIN
		<include refid="praiseCountAll" />
		ON idea.idea_id=praise.idea_id LEFT
		JOIN
		<include refid="wanToCountOfIdea" />
		ON wantto.idea_id=idea.idea_id
		where favorites.user_id=#{user_id}
		limit #{size},#{pageMaxSize}
	</select>

	<!-- 添加用户点赞 -->
	<insert id="addIdeaPraise" parameterType="string">
		<!-- insert into tb_idea_praise(user_id,idea_id) values(#{user_id},#{idea_id}) -->
		INSERT INTO tb_idea_praise(user_id,idea_id)
		(SELECT
		#{user_id},#{idea_id} FROM tb_idea_praise WHERE NOT EXISTS
		(SELECT *
		FROM tb_idea_praise WHERE user_id=#{user_id} AND idea_id=#{idea_id}
		)
		LIMIT 1)
	</insert>
	<!-- 用户取消点赞 -->
	<delete id="removePraise" parameterType="string">
		delete from
		tb_idea_praise where user_id=#{user_id} and idea_id=#{idea_id}
	</delete>
	<!-- 根据id查询某一个创意被点赞数量 -->
	<select id="praiseCountByidea_id" resultType="int"
		parameterType="string">
		select count(*) from tb_idea_praise where
		idea_id=#{idea_id}
	</select>

	<!-- 根据模块id查找模块 -->
	<select id="selectIdeaOfModule" resultMap="IdeaResult"
		parameterType="int">
		SELECT idea.idea_Id,idea.title,idea.detail,idea.picture,
		idea.type,idea.fromId,idea.createdate,idea.status,
		idea.views,favorites.favorites, praise.praise
		FROM tb_idea AS idea LEFT
		JOIN
		(SELECT COUNT(*) AS favorites
		,tb_idea.idea_id,tb_idea_favorites.user_id FROM
		tb_idea,tb_idea_favorites WHERE
		tb_idea.idea_id=tb_idea_favorites.idea_id) AS favorites
		ON
		idea.idea_id=favorites.idea_id LEFT JOIN
		(SELECT COUNT(*) AS
		praise,tb_idea.idea_id FROM tb_idea_praise,tb_idea WHERE
		tb_idea.idea_id=tb_idea_praise.idea_id) AS praise
		ON
		idea.idea_id=praise.idea_id

		JOIN (SELECT idea_id ,module_id FROM
		tb_idea_ideaandmodule)
		AS module ON idea.idea_id=module.idea_id WHERE
		module.module_id=#{module_id} and idea.status=#{status}
		limit
		#{size},#{pageMaxSize}
	</select>
	<select id="selectComment" resultType="com.gj.entity.Comment">
		SELECT
		idea_id,user_id,context FROM tb_idea AS idea JOIN
		tb_idea_comment AS
		idea_comment ON idea.idea_id= idea_comment.idea_id
		where
		idea.idea_id=#{idea_id}
	</select>
	<select id="selectCommentByIdeaId" resultType="com.gj.entity.Comment">
		SELECT
		comment_id,user_id,context FROM tb_idea_comment
		where tb_idea_comment.idea_id=#{idea_id}
	</select>
	<!-- 添加评论 -->
	<insert id="addComment" parameterType="com.gj.entity.Comment">
		INSERT INTO
		tb_idea_comment(idea_id,user_id,context)
		VALUES(#{idea_id},#{user.userId},#{context})
	</insert>

	<select id="selectCommentsByIdeaId" resultMap="commentResult"
		parameterType="com.doudinggongjiang.think.vo.IdeaParamerMeter1">
		select * from tb_idea_comment where idea_id=#{idea_id}
		limit
		#{size},#{pageMaxSize}
	</select>
	<delete id="removeComment" parameterType="com.doudinggongjiang.think.vo.IdeaParamerMeter1">
		delete from
		tb_idea_comment where user_id=#{user_id} and
		comment_id=#{comment_id}
	</delete>
	<select id="selectTypeByID" resultType="string">
		select type_name as type from tb_type where type_id=#{type}
	</select>
	<insert id="addWantTo" parameterType="com.doudinggongjiang.think.vo.IdeaParamer">
		insert into tb_idea_wantto(idea_id,user_id)
		values(#{idea.idea_Id},#{user_id})
	</insert>
	<delete id="removeWantto" parameterType="com.doudinggongjiang.think.vo.IdeaParamer">
		delete from tb_idea_wantto where idea_id=#{idea.idea_id} and
		user_id=#{user_id}
	</delete>
    <select id="selectRecommendIdea" resultMap="IdeaResult" parameterType="com.doudinggongjiang.think.vo.IdeaParamer">
      SELECT a4.*,a3.favorites,a7.COMMENT, a8.wanTto,a6.praise ,iswantto.iswantto,ispraise.ispraise,isfavorites.isfavorites
		 FROM tb_idea AS a4  
         LEFT JOIN (SELECT COUNT(*) AS praise ,idea_id FROM tb_idea_praise GROUP BY
		 idea_id )AS a6 ON a4.`idea_id`=a6.idea_id 
		 LEFT JOIN (SELECT COUNT(*) AS favorites,a1.idea_id FROM
		 tb_idea_favorites AS a1 GROUP BY a1.idea_id) AS a3 ON a4.idea_id=a3.idea_id
		 LEFT JOIN (SELECT COUNT(*) AS COMMENT ,idea_id FROM tb_idea_comment GROUP
		 BY idea_id )AS a7 ON a4.`idea_id`=a7.idea_id
		 LEFT JOIN (SELECT COUNT(*) AS wanTto,a2.idea_id FROM tb_idea_wantto AS a2 GROUP BY a2.idea_id) AS a8 ON a4.idea_id=a8.idea_id

		 LEFT JOIN
		<include refid="iswantto" />
		ON a4.idea_id=iswantto.idea_id
		LEFT JOIN
		<include refid="ispraise" />
		ON a4.idea_id=ispraise.idea_id
		LEFT JOIN
		<include refid="isfavorites" />
		ON a4.idea_id=isfavorites.idea_id 
		RIGHT JOIN (SELECT object_id  AS obj_id FROM tb_recommend where number=1) AS obj 
		ON a4.idea_id=obj.obj_id
		
		limit  #{size},#{pageMaxSize}
    </select>

</mapper>